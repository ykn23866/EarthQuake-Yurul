import requests
import time
import pygame
import pyttsx3
from datetime import datetime
import folium
from folium.plugins import MiniMap

class EarthquakeMonitor:
    def __init__(self):
        self.base_url = "https://earthquake.usgs.gov/fdsnws/event/1/query"
        self.last_update = None
        self.alerted_events = set()
        self.engine = pyttsx3.init()
        self.japan_bbox = "122.56,24.05,146.19,45.79"  # 日本地理边界
        
        # 初始化地图
        self.map = folium.Map(location=[36.2048, 138.2529], zoom_start=5)
        MiniMap().add_to(self.map)
        folium.TileLayer('Stamen Terrain').add_to(self.map)
        self.map.save('earthquake_map.html')

    def get_earthquake_data(self):
        params = {
            "format": "geojson",
            "starttime": self.last_update,
            "bbox": self.japan_bbox,
            "minmagnitude": 3.0
        }
        try:
            response = requests.get(self.base_url, params=params)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"Error fetching data: {e}")
            return None

    def analyze_tsunami_risk(self, earthquake):
        # 海啸风险评估逻辑
        if earthquake['properties']['tsunami'] == 1:
            return "海啸预警已发布！"
        if earthquake['properties']['mag'] >= 7.0 and earthquake['geometry']['coordinates'][2] < 50:
            return "可能引发海啸！"
        return "无海啸风险"

    def voice_alert(self, message):
        self.engine.say(message)
        self.engine.runAndWait()

    def update_map(self, earthquake):
        coord = earthquake['geometry']['coordinates']
        mag = earthquake['properties']['mag']
        popup_text = f"""
        震级: {mag}<br>
        时间: {datetime.fromtimestamp(earthquake['properties']['time']/1000)}<br>
        深度: {coord[2]} km
        """
        color = 'red' if mag >= 5.0 else 'orange'
        folium.CircleMarker(
            location=[coord[1], coord[0]],
            radius=mag*2,
            color=color,
            fill=True,
            popup=popup_text
        ).add_to(self.map)
        self.map.save('earthquake_map.html')

    def monitor(self):
        while True:
            data = self.get_earthquake_data()
            if data and data['features']:
                for eq in data['features']:
                    event_id = eq['id']
                    if event_id not in self.alerted_events:
                        # 更新地图
                        self.update_map(eq)
                        
                        # 生成警报信息
                        tsunami_info = self.analyze_tsunami_risk(eq)
                        alert_message = f"检测到地震。震级{eq['properties']['mag']}级，"
                        alert_message += f"位置：北纬{eq['geometry']['coordinates'][1]:.2f}度，"
                        alert_message += f"东经{eq['geometry']['coordinates'][0]:.2f}度。{tsunami_info}"
                        
                        # 语音播报
                        self.voice_alert(alert_message)
                        
                        self.alerted_events.add(event_id)
                
                self.last_update = datetime.now().isoformat()
            
            time.sleep(60)  # 每分钟检查一次更新

if __name__ == "__main__":
    monitor = EarthquakeMonitor()
    monitor.monitor()
